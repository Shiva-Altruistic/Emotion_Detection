<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Emotion Detection</title>

<style>
body {
  margin: 0;
  height: 100vh;
  background: #020617;
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: Arial;
  color: white;
}
h2 {
  position: absolute;
  top: 20px;
  color: #38bdf8;
}
.container {
  display: flex;
  gap: 50px;
}
.video-box {
  position: relative;
}
video, canvas {
  width: 320px;
  height: 320px;
  border-radius: 14px;
  border: 3px solid #38bdf8;
}
canvas {
  position: absolute;
  top: 0;
  left: 0;
}
.panel {
  background: #0f172a;
  padding: 25px;
  border-radius: 16px;
  width: 320px;
  text-align: center;
}
.emoji {
  font-size: 60px;
}
.stat {
  margin: 6px 0;
}
.graph {
  margin-top: 15px;
  background: #020617;
  border-radius: 10px;
}
</style>
</head>

<body>
<h2>Live Webcam Emotion Detection</h2>

<div class="container">

  <div class="video-box">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" width="320" height="320"></canvas>
  </div>

  <div class="panel">
    <div id="emoji" class="emoji">üòê</div>
    <div class="stat">Emotion: <span id="emotion">--</span></div>
    <div class="stat">Confidence: <span id="confidence">--%</span></div>
    <div class="stat">Accuracy: <span id="accuracy">--%</span></div>
    <div class="stat" id="reply">Waiting...</div>
    <canvas id="emotionGraph" class="graph" width="280" height="120"></canvas>
  </div>

</div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const g = document.getElementById("emotionGraph");
const gctx = g.getContext("2d");

let history = [];
const MAX = 20;

navigator.mediaDevices.getUserMedia({ video: true })
  .then(s => video.srcObject = s);

function color(e) {
  return {
    Happy:"#22c55e", Sad:"#3b82f6", Angry:"#ef4444",
    Fear:"#a855f7", Surprise:"#facc15", Neutral:"#94a3b8"
  }[e] || "#64748b";
}

function drawGraph() {
  gctx.clearRect(0,0,g.width,g.height);
  if (history.length < 2) return;
  const step = g.width/(MAX-1);
  gctx.beginPath();
  history.forEach((p,i)=>{
    const x=i*step;
    const y=g.height-(p.v/100)*g.height;
    gctx.strokeStyle=color(p.e);
    i?gctx.lineTo(x,y):gctx.moveTo(x,y);
  });
  gctx.stroke();
}

async function sendFrame() {
  if (!video.videoWidth) return;

  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const img = canvas.toDataURL("image/jpeg");

  const r = await fetch("/predict", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({image:img})
  });
  const d = await r.json();

  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  document.getElementById("emoji").innerText=d.emoji;
  document.getElementById("emotion").innerText=d.emotion;
  document.getElementById("confidence").innerText=d.confidence+"%";
  document.getElementById("accuracy").innerText=d.accuracy+"%";
  document.getElementById("reply").innerText=d.reply;

  if (d.face) {
    const [x,y,w,h]=d.face;
    ctx.strokeStyle="lime";
    ctx.lineWidth=3;
    ctx.strokeRect(x,y,w,h);
  }

  if (d.emotion!=="No face" && d.emotion!=="Error") {
    history.push({v:d.confidence,e:d.emotion});
    if(history.length>MAX) history.shift();
    drawGraph();
  }
}

setInterval(sendFrame, 800);
</script>

</body>
</html>
